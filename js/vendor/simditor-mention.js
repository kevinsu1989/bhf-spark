var SimditorMention,__hasProp={}.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};SimditorMention=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.pluginName="Mention",b.prototype.opts={mention:!1},b.prototype.active=!1,b.prototype._init=function(){if(this.opts.mention){if(this.editor=this._module,this.opts.mention=$.extend({items:[],url:"",nameKey:"name",pinyinKey:"pinyin",abbrKey:"abbr",itemRenderer:null,linkRenderer:null},this.opts.mention),!$.isArray(this.opts.mention.items)&&""===this.opts.mention.url)throw new Error("Must provide items or source url");return this.items=[],this.editor.formatter._allowedAttributes.a?this.editor.formatter._allowedAttributes.a.push("data-mention"):this.editor.formatter._allowedAttributes.a=["data-mention"],this.opts.mention.items.length>0?(this.items=this.opts.mention.items,this._renderPopover()):this.getItems(),this._bind()}},b.prototype.getItems=function(){return $.ajax({type:"get",url:this.opts.mention.url}).done(function(a){return function(b){return a.items=b,a._renderPopover()}}(this))},b.prototype._bind=function(){return this.editor.on("decorate",function(a){return function(b,c){return c.find("a[data-mention]").each(function(b,c){return a.decorate($(c))})}}(this)),this.editor.on("undecorate",function(a){return function(b,c){return c.find("a[data-mention]").each(function(b,c){return a.undecorate($(c))}),c.find("simditor-mention").children().unwrap()}}(this)),this.editor.on("pushundostate",function(a){return function(b){return a.editor.body.find("span.simditor-mention").length>0?!1:b.result}}(this)),this.editor.on("keydown",function(a){return function(b){return 229===b.which?setTimeout(function(){var b;return b=a.editor.selection.getRange(),null!=b&&b.collapsed?(b=b.cloneRange(),b.setStart(b.startContainer,Math.max(b.startOffset-1,0)),"@"===b.toString()?a.editor.trigger($.Event("keypress",{which:64})):void 0):void 0},0):void 0}}(this)),this.editor.on("keypress",function(a){return function(b){var c;if(64===b.which&&(c=a.editor.util.closestBlockEl(),!c.is("pre")))return setTimeout(function(){var b;return b=a.editor.selection.getRange(),null==b||(b=b.cloneRange(),b.setStart(b.startContainer,Math.max(b.startOffset-2,0)),/^[A-Za-z0-9]@/.test(b.toString()))?void 0:a.show()})}}(this)),this.editor.on("keydown.simditor-mention",$.proxy(this._onKeyDown,this)).on("keyup.simditor-mention",$.proxy(this._onKeyUp,this)),this.editor.on("blur",function(a){return function(){return a.active?a.hide():void 0}}(this)),this.editor.body.on("mousedown","a.simditor-mention",function(a){return function(b){var c,d,e,f;return c=$(b.currentTarget),d=$('<span class="simditor-mention edit" />').append(c.contents()),c.replaceWith(d),a.show(d),e=d.contents().eq(0),f=document.createRange(),f.selectNodeContents(e[0]),f.setStart(f.startContainer,1),a.editor.selection.selectRange(f),!1}}(this)),this.editor.wrapper.on("mousedown.simditor-mention",function(a){return function(b){return $(b.target).closest(".simditor-mention-popover",a.editor.wrapper).length?void 0:a.hide()}}(this))},b.prototype.show=function(a){var b;return this.active=!0,a?this.target=a:(this.target=$('<span class="simditor-mention" />'),b=this.editor.selection.getRange(),b.setStart(b.startContainer,b.endOffset-1),b.surroundContents(this.target[0])),this.editor.selection.setRangeAtEndOf(this.target,b),this.popoverEl.find(".item:first").addClass("selected").siblings(".item").removeClass("selected"),this.popoverEl.show(),this.popoverEl.find(".item").show(),this.refresh()},b.prototype.refresh=function(){var a,b,c,d;return d=this.editor.wrapper.offset(),b=this.target.offset(),a=this.popoverEl.height(),c=b.top-d.top+this.target.height()+2,b.top-$(document).scrollTop()+a>$(window).height()&&(c=b.top-d.top-a),this.popoverEl.css({top:c,left:b.left-d.left+this.target.width()})},b.prototype._renderPopover=function(){var a,b,c,d,e,f,g,h,i;for(this.popoverEl=$("<div class='simditor-mention-popover'>\n  <div class='items'></div>\n</div>").appendTo(this.editor.el),b=this.popoverEl.find(".items"),i=this.items,g=0,h=i.length;h>g;g++)d=i[g],e=d[this.opts.mention.nameKey],f=d[this.opts.mention.pinyinKey],c=d[this.opts.mention.abbrKey],a=$('<a class="item" href="javascript:;"\n  data-pinyin="'+f+'"\n  data-abbr="'+c+'">\n  <span></span>\n</a>'),a.attr("data-name",e).find("span").text(e),this.opts.mention.itemRenderer&&(a=this.opts.mention.itemRenderer(a,d)),a.appendTo(b).data("item",d);return this.popoverEl.on("mouseenter",".item",function(){return $(this).addClass("selected").siblings(".item").removeClass("selected")}),this.popoverEl.on("mousedown",".item",function(a){return function(){return a.selectItem(),!1}}(this)),b.on("mousewheel",function(a,b){return $(this).scrollTop($(this).scrollTop()-10*b),!1})},b.prototype.decorate=function(a){return a.addClass("simditor-mention")},b.prototype.undecorate=function(a){return a.removeClass("simditor-mention")},b.prototype.hide=function(){return this.target&&(this.target.contents().first().unwrap(),this.target=null),this.popoverEl.hide().find(".item").removeClass("selected"),this.active=!1,null},b.prototype.selectItem=function(){var a,b,c,d,e,f;return b=this.popoverEl.find(".item.selected"),b.length>0?(c=b.data("item"),d=c.url||"javascript:;",a=$("<a/>",{"class":"simditor-mention",text:"@"+b.attr("data-name"),href:d,"data-mention":!0}),this.target.replaceWith(a),this.editor.trigger("mention",[a,c]),this.opts.mention.linkRenderer&&this.opts.mention.linkRenderer(a,c),this.target.hasClass("edit")?this.editor.selection.setRangeAfter(a):(f=document.createTextNode("\xa0"),a.after(f),e=document.createRange(),this.editor.selection.setRangeAtEndOf(f,e)),this.hide()):void 0},b.prototype.filterItem=function(){var a,b,c,d,e;e=this.target.text().toLowerCase().substr(1).replace(/'/g,"");try{c=new RegExp("(|\\s)"+e,"i")}catch(f){b=f,c=new RegExp("","i")}return a=this.popoverEl.find(".item"),d=a.hide().removeClass("selected").filter(function(){var b,d;return b=$(this),d=[b.data("name"),b.data("pinyin"),b.data("abbr")].join(" "),c.test(d)}),d.length?(this.popoverEl.show(),d.show().first().addClass("selected")):this.popoverEl.hide()},b.prototype._onKeyDown=function(a){var b,c,d,e,f,g,h,i;if(this.active)return 37===a.which||39===a.which||27===a.which?(this.editor.selection.save(),this.hide(),this.editor.selection.restore(),!1):38===a.which||40===a.which?(h=this.popoverEl.find(".item.selected"),h.length<1?(this.popoverEl.find(".item:first".addClass("selected")),!1):(b=h[38===a.which?"prevAll":"nextAll"](".item:visible").first(),b.length<1?!1:(h.removeClass("selected"),b.addClass("selected"),e=b.parent(),f=e.height(),g=b.position(),c=b.outerHeight(),g.top>f-c&&e.scrollTop(c*b.prevAll(".item:visible").length-f+c),g.top<0&&e.scrollTop(c*b.prevAll(".item:visible").length),!1))):13===a.which||9===a.which?(h=this.popoverEl.find(".item.selected"),h.length?(this.selectItem(),!1):(d=document.createTextNode(this.target.text()),this.target.before(d).remove(),this.hide(),this.editor.selection.setRangeAtEndOf(d))):8===a.which&&"@"===this.target.text()?(d=document.createTextNode("@"),this.target.replaceWith(d),this.hide(),this.editor.selection.setRangeAtEndOf(d)):32===a.which?(i=this.target.text(),h=this.popoverEl.find(".item.selected"),h.length&&i.substr(1)===h.text().trim()?this.selectItem():(d=document.createTextNode(i+"\xa0"),this.target.before(d).remove(),this.hide(),this.editor.selection.setRangeAtEndOf(d)),!1):void 0},b.prototype._onKeyUp=function(a){return!this.active||$.inArray(a.which,[9,16,50,27,37,38,39,40,32])>-1?void 0:(this.filterItem(),this.refresh())},b}(SimpleModule),Simditor.connect(SimditorMention);