(function(){var t,e={}.hasOwnProperty,i=function(t,i){function n(){this.constructor=t}for(var o in i)e.call(i,o)&&(t[o]=i[o]);return n.prototype=i.prototype,t.prototype=new n,t.__super__=i.prototype,t},n=[].slice;t=function(t){function e(){var t;t=1<=arguments.length?n.call(arguments,0):[],e.__super__.constructor.apply(this,t),this.editor=this.widget}return i(e,t),e.className="Mention",e.prototype.opts={mention:!1},e.prototype.active=!1,e.prototype._init=function(){if(this.opts.mention){if(this.opts.mention=$.extend({items:[],url:"",nameKey:"name",pinyinKey:"pinyin",abbrKey:"abbr",itemRenderer:null,linkRenderer:null},this.opts.mention),!$.isArray(this.opts.mention.items)&&""===this.opts.mention.url)throw new Error("Must provide items or source url");return this.items=[],this.editor.formatter._allowedAttributes.a?this.editor.formatter._allowedAttributes.a.push("data-mention"):this.editor.formatter._allowedAttributes.a=["data-mention"],this.opts.mention.items.length>0?(this.items=this.opts.mention.items,this._renderPopover()):this.getItems(),this._bind()}},e.prototype.getItems=function(){return $.ajax({type:"get",url:this.opts.mention.url}).done(function(t){return function(e){return t.items=e,t._renderPopover()}}(this))},e.prototype._bind=function(){return this.editor.on("decorate",function(t){return function(e,i){return i.find("a[data-mention]").each(function(e,i){return t.decorate($(i))})}}(this)),this.editor.on("undecorate",function(t){return function(e,i){return i.find("a[data-mention]").each(function(e,i){return t.undecorate($(i))}),i.find("simditor-mention").children().unwrap()}}(this)),this.editor.on("pushundostate",function(t){return function(e){return t.editor.body.find("span.simditor-mention").length>0?!1:e.result}}(this)),this.editor.on("keydown",function(t){return function(e){return 229===e.which?setTimeout(function(){var e;return e=t.editor.selection.getRange(),null!=e&&e.collapsed?(e=e.cloneRange(),e.setStart(e.startContainer,Math.max(e.startOffset-1,0)),"@"===e.toString()?t.editor.trigger($.Event("keypress"),{which:64}):void 0):void 0},0):void 0}}(this)),this.editor.on("keypress",function(t){return function(e){var i;if(64===e.which&&(i=t.editor.util.closestBlockEl(),!i.is("pre")))return setTimeout(function(){var e;return e=t.editor.selection.getRange(),null==e||(e=e.cloneRange(),e.setStart(e.startContainer,Math.max(e.startOffset-2,0)),/^[A-Za-z0-9]@/.test(e.toString()))?void 0:t.show()})}}(this)),this.editor.on("keydown.simditor-mention",$.proxy(this._onKeyDown,this)).on("keyup.simditor-mention",$.proxy(this._onKeyUp,this)),this.editor.on("blur",function(t){return function(){return t.active?t.hide():void 0}}(this)),this.editor.body.on("mousedown","a.simditor-mention",function(t){return function(e){var i,n,o,r;return i=$(e.currentTarget),n=$('<span class="simditor-mention edit" />').append(i.contents()),i.replaceWith(n),t.show(n),o=n.contents().eq(0),r=document.createRange(),r.selectNodeContents(o[0]),r.setStart(r.startContainer,1),t.editor.selection.selectRange(r),!1}}(this)),this.editor.wrapper.on("mousedown.simditor-mention",function(t){return function(e){return $(e.target).closest(".simditor-mention-popover",t.editor.wrapper).length?void 0:t.hide()}}(this))},e.prototype.show=function(t){var e;return this.active=!0,t?this.target=t:(this.target=$('<span class="simditor-mention" />'),e=this.editor.selection.getRange(),e.setStart(e.startContainer,e.endOffset-1),e.surroundContents(this.target[0])),this.editor.selection.setRangeAtEndOf(this.target,e),this.popoverEl.find(".item:first").addClass("selected").siblings(".item").removeClass("selected"),this.popoverEl.show(),this.popoverEl.find(".item").show(),this.refresh()},e.prototype.refresh=function(){var t,e;return e=this.editor.wrapper.offset(),t=this.target.offset(),this.popoverEl.css({top:t.top-e.top+this.target.height()+2,left:t.left-e.left+this.target.width()})},e.prototype._renderPopover=function(){var t,e,i,n,o,r,s,a,h;for(this.popoverEl=$("<div class='simditor-mention-popover'>\n  <div class='items'></div>\n</div>").appendTo(this.editor.el),e=this.popoverEl.find(".items"),h=this.items,s=0,a=h.length;a>s;s++)n=h[s],o=n[this.opts.mention.nameKey],r=n[this.opts.mention.pinyinKey],i=n[this.opts.mention.abbrKey],t=$('<a class="item" href="javascript:;"\n  data-pinyin="'+r+'"\n  data-abbr="'+i+'">\n  <span></span>\n</a>'),t.attr("data-name",o).find("span").text(o),this.opts.mention.itemRenderer&&(t=this.opts.mention.itemRenderer(t,n)),t.appendTo(e).data("item",n);return this.popoverEl.on("mouseenter",".item",function(){return $(this).addClass("selected").siblings(".item").removeClass("selected")}),this.popoverEl.on("mousedown",".item",function(t){return function(){return t.selectItem(),!1}}(this)),e.on("mousewheel",function(t,e){return $(this).scrollTop($(this).scrollTop()-10*e),!1})},e.prototype.decorate=function(t){return t.addClass("simditor-mention")},e.prototype.undecorate=function(t){return t.removeClass("simditor-mention")},e.prototype.hide=function(){return this.target&&(this.target.contents().first().unwrap(),this.target=null),this.popoverEl.hide().find(".item").removeClass("selected"),this.active=!1,null},e.prototype.selectItem=function(){var t,e,i,n,o,r;return e=this.popoverEl.find(".item.selected"),e.length>0?(i=e.data("item"),n=i.url||"javascript:;",t=$("<a/>",{"class":"simditor-mention",text:"@"+e.attr("data-name"),href:n,"data-mention":!0}),this.target.replaceWith(t),this.editor.trigger("mention",[t,i]),this.opts.mention.linkRenderer&&this.opts.mention.linkRenderer(t,i),this.target.hasClass("edit")?this.editor.selection.setRangeAfter(t):(r=document.createTextNode(" "),t.after(r),o=document.createRange(),this.editor.selection.setRangeAtEndOf(r,o)),this.hide()):void 0},e.prototype.filterItem=function(){var t,e,i,n,o;o=this.target.text().toLowerCase().substr(1).replace(/'/g,"");try{i=new RegExp(o,"i")}catch(r){e=r,i=new RegExp("","i")}return t=this.popoverEl.find(".item"),n=t.hide().removeClass("selected").filter(function(){var t,e;return t=$(this),e=[t.data("name"),t.data("pinyin"),t.data("abbr")].join(" "),i.test(e)}),n.length?(this.popoverEl.show(),n.show().first().addClass("selected")):this.popoverEl.hide()},e.prototype._onKeyDown=function(t){var e,i,n,o,r,s,a,h;if(this.active)return 37===t.which||39===t.which||27===t.which?(this.editor.selection.save(),this.hide(),this.editor.selection.restore(),!1):38===t.which||40===t.which?(a=this.popoverEl.find(".item.selected"),a.length<1?(this.popoverEl.find(".item:first".addClass("selected")),!1):(e=a[38===t.which?"prevAll":"nextAll"](".item:visible").first(),e.length<1?!1:(a.removeClass("selected"),e.addClass("selected"),o=e.parent(),r=o.height(),s=e.position(),i=e.outerHeight(),s.top>r-i&&o.scrollTop(i*e.prevAll(".item:visible").length-r+i),s.top<0&&o.scrollTop(i*e.prevAll(".item:visible").length),!1))):13===t.which||9===t.which?(a=this.popoverEl.find(".item.selected"),a.length?(this.selectItem(),!1):(n=document.createTextNode(this.target.text()),this.target.before(n).remove(),this.hide(),this.editor.selection.setRangeAtEndOf(n))):8===t.which&&"@"===this.target.text()?(n=document.createTextNode("@"),this.target.replaceWith(n),this.hide(),this.editor.selection.setRangeAtEndOf(n)):32===t.which?(h=this.target.text(),a=this.popoverEl.find(".item.selected"),a.length&&h.substr(1)===a.text().trim()?this.selectItem():(n=document.createTextNode(h+" "),this.target.before(n).remove(),this.hide(),this.editor.selection.setRangeAtEndOf(n)),!1):void 0},e.prototype._onKeyUp=function(t){return!this.active||$.inArray(t.which,[9,16,50,27,37,38,39,40,32])>-1?void 0:(this.filterItem(),this.refresh())},e}(Plugin),Simditor.connect(t)}).call(this);