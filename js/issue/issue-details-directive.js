// Generated by CoffeeScript 1.7.1
(function() {
  define(['../ng-module', '../utils', '_'], function(_module, _utils, _) {
    return _module.directiveModule.directive('issueDetails', function($rootScope, API, NOTIFY) {
      return {
        restrict: 'A',
        replace: true,
        link: function(scope, element, attr) {
          var editorKey, submitComment;
          editorKey = 'issue';
          scope.editing = false;
          scope.showAlwaysTop = true;
          submitComment = function(data) {
            var url;
            url = "" + scope.api + "/comment";
            return API.post(url, {
              content: data.content
            }).then(function(result) {
              return NOTIFY.success('评论保存成功');
            });
          };
          scope.$watch('issue', function() {
            if (!scope.issue) {
              return;
            }
            return scope.api = "project/" + scope.issue.project_id + "/issue/" + scope.issue.id;
          });
          scope.$on('dropdown:selected', function(event, type, value) {
            switch (type) {
              case 'issue:owner':
                return API.put("" + scope.api + "/plan", {
                  owner: value
                });
              case 'issue:priority':
                return API.put("" + scope.api + "/priority", {
                  priority: value
                });
            }
          });
          scope.onClickDelete = function($event) {
            return alert('删除issue');
          };
          scope.onClickEdit = function($event) {
            scope.editing = true;
            return window.setTimeout((function() {
              return scope.$broadcast('editor:content', editorKey, scope.issue.content);
            }), 1);
          };
          scope.$on('editor:submit', function(event, name, data) {
            var newData;
            if (name === 'comment') {
              return submitComment(data);
            }
            scope.editing = false;
            scope.issue.content = data.content;
            newData = _.pick(scope.issue, ['content', 'title']);
            return API.put(scope.api, newData).then(function(result) {
              return NOTIFY.success('更新成功');
            });
          });
          return scope.$on('editor:cancel', function(event, name) {
            if (editorKey !== name) {
              return;
            }
            return scope.editing = false;
          });
        }
      };
    });
  });

}).call(this);

//# sourceMappingURL=issue-details-directive.map
